{% extends "workouts/layout.html" %}
{% load static %}
{% block title %}Dashboard | IronLog{% endblock %}

{% block body %}
<div class="container mt-5" style="max-width: 1000px;">

  <!-- ğŸ§® Summary Card -->
  <div class="card shadow-sm p-4 mb-4">
    <h3 class="text-center mb-4">ğŸ‹ï¸ Performance Summary</h3>
    <div class="row text-center">
      <div class="col-md-3">
        <h6 class="text-muted mb-1">Best Squat</h6>
        <h4>{{ best_squat.weight|default:"â€”" }} kg</h4>
      </div>
      <div class="col-md-3">
        <h6 class="text-muted mb-1">Best Bench</h6>
        <h4>{{ best_bench.weight|default:"â€”" }} kg</h4>
      </div>
      <div class="col-md-3">
        <h6 class="text-muted mb-1">Best Deadlift</h6>
        <h4>{{ best_deadlift.weight|default:"â€”" }} kg</h4>
      </div>
      <div class="col-md-3 border-start">
        <h6 class="text-muted mb-1">Total (SBD)</h6>
        <h4>{{ total|default:"0" }} kg</h4>
        {% if wilks %}
          <small class="text-muted">Wilks: <strong>{{ wilks }}</strong></small>
        {% else %}
          <small class="text-muted">Wilks: â€”</small>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ğŸ“Š Title & Period Filter -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>ğŸ“ˆ Training Analytics</h3>
    <div>
      <a href="?period=weekly" class="btn btn-sm {% if period == 'weekly' %}btn-primary{% else %}btn-outline-primary{% endif %}">
        Weekly
      </a>
      <a href="?period=monthly" class="btn btn-sm {% if period == 'monthly' %}btn-primary{% else %}btn-outline-primary{% endif %}">
        Monthly
      </a>
    </div>
  </div>

  <div class="text-end mb-3">
    <a href="{% url 'export_workouts_csv' %}" class="btn btn-outline-secondary btn-sm me-2">
        â¬‡ï¸ Export Workouts CSV
    </a>
    <a href="{% url 'export_prs_csv' %}" class="btn btn-outline-secondary btn-sm">
        ğŸ† Export PRs CSV
    </a>
  </div>

  <!-- Chart 1: Volume Over Time -->
  <div class="card shadow-sm p-4 mb-4">
    <h5 class="text-center mb-3">Total Training Volume Over Time</h5>
    <canvas id="volumeChart"></canvas>
    {% if not volumes %}
      <p class="text-center text-muted mt-3 mb-0">No data yet. Log a workout ğŸ’ª</p>
    {% endif %}
  </div>

  <!-- Chart 2: Volume by Exercise -->
  <div class="card shadow-sm p-4 mb-4">
    <h5 class="text-center mb-3">Volume by Exercise</h5>
    <canvas id="exerciseChart"></canvas>
    {% if not exercise_labels %}
      <p class="text-center text-muted mt-3 mb-0">No exercise volume yet.</p>
    {% endif %}
  </div>

  <!-- Chart 3: PR Progression -->
  <div class="card shadow-sm p-4 mb-4">
    <h5 class="text-center mb-3">ğŸ† PR Progression (Squat / Bench / Deadlift)</h5>
    <canvas id="prChart"></canvas>
    {% if not pr_labels %}
      <p class="text-center text-muted mt-3 mb-0">No PR data yet.</p>
    {% endif %}
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Pass data safely -->
{{ labels|json_script:"labels-data" }}
{{ volumes|json_script:"volumes-data" }}
{{ exercise_labels|json_script:"exercise-labels-data" }}
{{ exercise_volumes|json_script:"exercise-volumes-data" }}
{{ pr_labels|json_script:"pr-labels-data" }}
{{ squat_weights|json_script:"squat-weights-data" }}
{{ bench_weights|json_script:"bench-weights-data" }}
{{ deadlift_weights|json_script:"deadlift-weights-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Safe JSON Data -->
{{ labels|json_script:"labels-data" }}
{{ volumes|json_script:"volumes-data" }}
{{ exercise_labels|json_script:"exercise-labels-data" }}
{{ exercise_volumes|json_script:"exercise-volumes-data" }}
{{ pr_labels|json_script:"pr-labels-data" }}
{{ squat_weights|json_script:"squat-weights-data" }}
{{ bench_weights|json_script:"bench-weights-data" }}
{{ deadlift_weights|json_script:"deadlift-weights-data" }}

<script>
  let charts = {};

  function getChartColors() {
    const isLight = document.body.classList.contains("theme-light");
    return {
      bgColor: isLight ? "#ffffff" : "#202020",
      gridColor: isLight ? "rgba(0,0,0,0.1)" : "rgba(255,255,255,0.1)",
      textColor: isLight ? "#222" : "#ccc",
      tooltipBg: isLight ? "rgba(0,0,0,0.8)" : "rgba(255,255,255,0.1)",
      tooltipText: "#fff"
    };
  }

  function chartOptions(yLabel, dataArray, aspect = 2.2) {
    const colors = getChartColors();
    const maxValue = Math.max(...dataArray, 100);
    const minValue = Math.min(...dataArray, 0);

    return {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: aspect,
      backgroundColor: colors.bgColor,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: colors.tooltipBg,
          titleColor: colors.tooltipText,
          bodyColor: colors.tooltipText,
          borderColor: "#b91c1c",
          borderWidth: 1,
          callbacks: {
            label: (context) => `${context.parsed.y.toLocaleString()} kg`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          suggestedMin: minValue * 0.95,
          suggestedMax: maxValue * 1.15,
          ticks: {
            color: colors.textColor,
            callback: (value) => value.toLocaleString() + " kg"
          },
          grid: { color: colors.gridColor },
          title: { display: true, text: yLabel, color: colors.textColor }
        },
        x: {
          ticks: { color: colors.textColor },
          grid: { color: colors.gridColor }
        }
      }
    };
  }

  function renderCharts() {
    // Clean previous
    Object.values(charts).forEach(c => c.destroy());
    charts = {};

    const labels = JSON.parse(document.getElementById("labels-data").textContent || "[]");
    const volumes = JSON.parse(document.getElementById("volumes-data").textContent || "[]");
    const exLabels = JSON.parse(document.getElementById("exercise-labels-data").textContent || "[]");
    const exVolumes = JSON.parse(document.getElementById("exercise-volumes-data").textContent || "[]");
    const prLabels = JSON.parse(document.getElementById("pr-labels-data").textContent || "[]");
    const squatWeights = JSON.parse(document.getElementById("squat-weights-data").textContent || "[]");
    const benchWeights = JSON.parse(document.getElementById("bench-weights-data").textContent || "[]");
    const deadliftWeights = JSON.parse(document.getElementById("deadlift-weights-data").textContent || "[]");

    const ctx1 = document.getElementById("volumeChart");
    const ctx2 = document.getElementById("exerciseChart");
    const ctx3 = document.getElementById("prChart");

    const colors = getChartColors();
    [ctx1, ctx2, ctx3].forEach(ctx => {
      if (ctx) ctx.style.backgroundColor = colors.bgColor;
    });

    // Chart 1
    if (labels.length > 0) {
      charts.volume = new Chart(ctx1, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Training Volume (kg lifted)",
            data: volumes,
            borderColor: "rgba(54, 162, 235, 1)",
            backgroundColor: "rgba(54, 162, 235, 0.2)",
            fill: true,
            tension: 0.3,
            pointRadius: 5,
            pointBackgroundColor: "#b91c1c"
          }]
        },
        options: chartOptions("Volume (kg)", volumes, 2.5)
      });
    }

    // Chart 2
    if (exLabels.length > 0) {
      charts.exercise = new Chart(ctx2, {
        type: "bar",
        data: {
          labels: exLabels,
          datasets: [{
            label: "Volume (kg)",
            data: exVolumes,
            backgroundColor: "rgba(185, 28, 28, 0.5)",
            borderColor: "rgba(185, 28, 28, 1)",
            borderWidth: 1
          }]
        },
        options: chartOptions("Volume (kg)", exVolumes, 2)
      });
    }

    // Chart 3
    if (prLabels.length > 0) {
      const allWeights = [...squatWeights, ...benchWeights, ...deadliftWeights];
      charts.pr = new Chart(ctx3, {
        type: "line",
        data: {
          labels: prLabels,
          datasets: [
            {
              label: "Squat",
              data: squatWeights,
              borderColor: "rgba(255, 99, 132, 1)",
              backgroundColor: "rgba(255, 99, 132, 0.2)",
              fill: false,
              tension: 0.3,
              pointBackgroundColor: "rgba(255, 99, 132, 1)"
            },
            {
              label: "Bench",
              data: benchWeights,
              borderColor: "rgba(255, 206, 86, 1)",
              backgroundColor: "rgba(255, 206, 86, 0.2)",
              fill: false,
              tension: 0.3,
              pointBackgroundColor: "rgba(255, 206, 86, 1)"
            },
            {
              label: "Deadlift",
              data: deadliftWeights,
              borderColor: "rgba(75, 192, 192, 1)",
              backgroundColor: "rgba(75, 192, 192, 0.2)",
              fill: false,
              tension: 0.3,
              pointBackgroundColor: "rgba(75, 192, 192, 1)"
            }
          ]
        },
        options: {
          ...chartOptions("Weight (kg)", allWeights, 2.5),
          plugins: { legend: { position: "bottom", labels: { color: getChartColors().textColor } } }
        }
      });
    }
  }

  // Render charts initially
  renderCharts();

  // Rerender on theme toggle
  const themeBtn = document.querySelector(".btn-outline-iron");
  if (themeBtn) {
    themeBtn.addEventListener("click", () => {
      setTimeout(renderCharts, 200);
    });
  }
</script>

{% endblock %}
